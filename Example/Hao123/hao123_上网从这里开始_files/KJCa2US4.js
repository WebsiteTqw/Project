define(["../models/SongDataModel","../models/ListCtrl","../models/PlayerRuleCtrl","../models/StatsRecorder","../models/LogCtrl","../models/UserModel"],function(SongDataModel,ListCtrl,PlayRuleCtrl,StatsRecorder,LogCtrl,UserModel){window.player=new PlayEngine({subEngines:[{constructorName:"PlayEngine_Audio"},{constructorName:"PlayEngine_FMP_MP3",args:{swfPath:"common/static/flash/fmp.swf",instanceName:"player"}}]});player.init();var CONF={MAXTITLE:200,MAXLINK:10,MAXLOCAL:500,UPDATEMORE:200,LOCALINIT:200,PREBUFTIME:10,BUFTIME:10,MULTBUFTIME:20,ERRTIME:1,SAVETIME:60,WMP:true,FMP:true,AUDIO:true,ERRSTOP:30};var staticTop={dayhot:true,"new":true};var staticLoadCollectFirst=true;var Player=Backbone.Model.extend({initialize:function(){this.player=player;this.listCtrl=new ListCtrl({playcore:this.player});this.playList=this.listCtrl.get("playlist");this.playerRuleCtrl=new PlayRuleCtrl({player:this.player,listCtrl:this.listCtrl,PLAYRULES:CONF});this.statsRecorder=new StatsRecorder({player:this.player,playerRuleCtrl:this.playerRuleCtrl,listCtrl:this.listCtrl});this.userModel=new UserModel;this.logCtrl=new LogCtrl({models:{statsRecorder:this.statsRecorder,playList:this.playList,playCore:this.player,userModel:this.userModel}})},_addSongs:function(ids,forceplay,listId){var songModels=SongDataModel.createSongModel(ids);forceplay=forceplay||false;SongDataModel.fetchSongTitleData(songModels,{success:_.bind(function(songs){this.playList.addSong(songs,{listId:listId});forceplay&&this.playList.setCurSongIndex(0)},this)})},playSong:function(ids,forceplay){ids=unescape(decodeURIComponent(ids)).replace(/(_{2,})/g,"_");if(ids){ids=ids.split("_")}else{ids=[]}this._addSongs(ids,forceplay)},playAlbum:function(id,forceplay){SongDataModel.fetchSongByAlbum(id,{type:"album",success:_.bind(function(data){var ids=data.songIdList;this._addSongs(ids,forceplay)},this)})},playTop:function(id,forceplay){if(this._reload(id)){return}this.trigger("addSong:start");if(staticTop[id]){var url="http://embed.music.baidu.com/cms/"+id+"songlist.js";$.getScript(url,_.bind(function(){SongDataModel.fetchSongTitleDataFromLocal(mbox["_"+id],{success:_.bind(function(songs){this.playList.addSong(songs,{listId:id});forceplay&&this.playList.setCurSongIndex(0)},this)})},this))}else{SongDataModel.fetchSongByTop(id,{success:_.bind(function(data){var ids=data.songIdList;this._addSongs(ids,forceplay,id)},this)})}},playCollect:function(forceplay){this.playList.setShowList("collect");if(this.playList.get("playListId")==="collect"){return}SongDataModel.fetchSongCollected({success:_.bind(function(data){var songList=data.data.songList;if(songList.length>0){if(staticLoadCollectFirst){this.trigger("addSong:start");staticLoadCollectFirst=!staticLoadCollectFirst}var ids=_.pluck(songList,"id"),songs=this.playList.getListById("collect");songs.length=0;this._addSongs(ids,forceplay,"collect")}else{this.trigger("collect:nosong")}},this),failure:_.bind(function(errorCode){if(errorCode==22452){this.trigger("collect:logout")}},this)})},_reload:function(listId){this.playList.setShowList(listId);var list=this.playList.getListById(listId);return list.length!==0},collectSong:function(index,options){var opt=this._getCollectSong(index,options);this._collectSong(opt)},cancelCollectSong:function(index,options){var opt=this._getCollectSong(index,options);this._cancelCollectSong(opt)},_getCollectSong:function(index,options){options=options||{};if(_.isObject(index)||_.isUndefined(index)){$.extend(options,index);options.song=this.playList.getViewCurSong();options.listId=this.playList.get("playListId");options.from="info"}else{options.song=this.playList.getShowModels()[index];options.listId=this.playList.get("showListId");options.index=index}return options},_collectSong:function(options){options=options||{};var model=options.song;if(!model||!model.songId){return}$.ajax({url:"/data/user/collect",dataType:"json",data:{ids:model.songId,type:"song"},type:"POST",content:this,cache:false,async:false,success:_.bind(function(data){if(!options.index){options.index=this.playList.getCurSongIndex();options.index=options.index==-1?0:options.index}if(data.errorCode==22e3||data.errorCode==22322){curSong=this.playList.getViewCurSong();model.set({hasCollected:true});if(curSong&&model.queryId==curSong.queryId){this.playList.trigger("change:curSongStatus",true)}this.playList.trigger("change:collectionStatus",true,options);if(_.isFunction(options.success)){options.success()}}else if(data.errorCode==22452){var opt={action:"collect",collect:true};if(!options.from||options.from!="info"){opt.index=options.index}this.userModel.login(opt)}},this)})},_cancelCollectSong:function(options){options=options||{};var model=options.song;if(!model||!model.songId){return}$.ajax({url:"/data/user/deleteCollection",dataType:"json",data:{ids:model.songId,type:"song"},type:"POST",content:this,cache:false,success:_.bind(function(data){if(!options.index){options.index=this.playList.getCurSongIndex();options.index=options.index==-1?0:options.index}if(data.errorCode==22e3){curSong=this.playList.getViewCurSong();model.set({hasCollected:false});if(curSong&&model.queryId==curSong.queryId){this.playList.trigger("change:curSongStatus",false)}this.playList.trigger("change:collectionStatus",false,options)}else if(data.errorCode==22452){var opt={action:"collect",collect:false};if(!options.from||options.from!="info"){opt.index=options.index}this.userModel.login(opt)}},this)})},setVolume:function(val){this.player.setVolume(val);this.trigger("change:volume",this,val)}});var medusa=new Player;window.medusa=medusa;return medusa});
/** If u are interested in our code and would like to make it robust, just contact us^^  <enimong#gmail.com> **/
/** Generated by M3D. **/