define(function(){var StatsRecorder=Backbone.Model.extend({defaults:{lid:Math.random()*+new Date,position:0,linkerr:"",auto:0,load2play:-1,start2play:-1,fromload:-1,fromstart:-1,buftime:-1,buftotal:-1,isclosed:0,bufp:-1,bufc:-1,songdur:0,link:"",playlist:"",showlist:"",preStatus:"",curStatus:"",curSong:null,playedTimes:0,playErrTimes:0,linkErrTimes:0,open2play:-1,open2load:-1,open2close:-1},stopwatches:{playStart:new mbox.StopWatch,loadLink:new mbox.StopWatch,bufTotal:new mbox.StopWatch,bufCost:new mbox.StopWatch},initialize:function(options){options=options||{};this.player=options.player||player;this.playerRuleCtrl=options.playerRuleCtrl||playerRuleCtrl;this.listCtrl=options.listCtrl||listCtrl;this.playListCtrl=this.listCtrl.get("playlist");this.listenPlayer();this.listenPlayerRules();this.listenPlayList();this._openTime=window._boxOpenTime||+new Date;var self=this;$(window).on("beforeunload",function(){if(self.get("curSong")){self.set("isclosed",1);self.set("open2close",+new Date-self._openTime);self._setCurStatus("playend")}setTimeout(function(){},500)})},listenPlayer:function(){var self=this;var watches=this.stopwatches;this.player.setEventListener(this.player.EVENTS.STATECHANGE,function(e){var STATES=self.player.STATES;switch(e.newState){case STATES.END:break;case STATES.PLAY:watches.bufTotal.pause();if(self.get("open2load")<0){self.set("open2load",+new Date-self._openTime)}if(self.get("open2play")<0){self.set("open2play",+new Date-self._openTime)}break;case STATES.PREBUFFER:watches.bufTotal.start();self.set("buftime",self.get("buftime")+1);if(self.get("open2load")<0){self.set("open2load",+new Date-self._openTime)}if(self.get("open2play")<0){self.set("open2play",+new Date-self._openTime)}break;case STATES.BUFFERING:watches.bufTotal.start();self.set("buftime",self.get("buftime")+1);break;case STATES.PAUSE:watches.bufTotal.pause();break;case STATES.STOP:watches.bufTotal.pause();break;case STATES.READY:watches.bufTotal.pause();break;case STATES.ERROR:watches.bufTotal.pause();self.set("playErrTimes",self.get("playErrTimes")+1);self._setCurStatus("playerr");break;default:}});this.player.setEventListener(this.player.EVENTS.PROGRESS,function(e){var loaded=e.progress*100;self.set("bufp",loaded);if(!self.get("songdur")){self.set("songdur",e.totalTime)}self.set("bufc",watches.bufCost.getTime());if(loaded==100){watches.bufCost.pause()}});this.player.setEventListener(this.player.EVENTS.POSITIONCHANGE,function(e){var pos=Math.max(e.position,self.get("position"));self.set("position",pos)})},listenPlayerRules:function(){var self=this;this.playerRuleCtrl.bind("playerRule:prebuffer",function(){self._setCurStatus("loadfileerr")});this.playerRuleCtrl.bind("playerRule:firstBuffer",function(){self._setCurStatus("buferr")});this.playerRuleCtrl.bind("playerRule:exception",function(){self._setCurStatus("playerr");self.set("playErrTimes",self.get("playErrTimes")+1)});this.playerRuleCtrl.bind("playerRule:play60s",function(){self._setCurStatus("60play");self.set("playedTimes",self.get("playedTimes")+1)});this.playerRuleCtrl.bind("playerRule:play100ms",function(){self._setCurStatus("playsong100ms");self.set("start2play",self.stopwatches.playStart.getTime());self.set("load2play",self.stopwatches.loadLink.getTime());self.set("playErrTimes",0);self.set("linkErrTimes",0)})},listenPlayList:function(){var watches=this.stopwatches;this.listCtrl.bind("playcomplete",function(){this.set("auto",1);watches.bufTotal.pause();this._setCurStatus("playcomplete")},this);this.listCtrl.bind("change:curSong",function(listCtrl,curSong){if(this.get("curSong")){this._setCurStatus("playend")}if(curSong){this.set("auto",0);watches.playStart.reset();watches.loadLink.reset();watches.bufTotal.reset();watches.bufCost.reset();this.set("load2play",-1);this.set("start2play",-1);this.set("bufp",0);this.set("buftime",-1);this.set("linkerr","");this.set("bufc",0);this.set("songdur",0);watches.playStart.start();this.set("curSong",curSong);this._setCurStatus("playstart")}},this);this.listCtrl.bind("change:songLink",function(listCtrl,curSong){if(curSong.get("songLink")){watches.loadLink.start();watches.bufCost.start();this.set("songdur",curSong.get("time")*1e3);this.set("link",curSong.get("songLink"));this._setCurStatus("load")}else{this.set("linkerr","blank");this._setCurStatus("linkfail");this.set("linkErrTimes",this.get("linkErrTimes")+1)}},this);this.playListCtrl.on("change:playList",function(newId){this.set("playlist",newId);if(this.get("open2load")<0){this.set("open2load",+new Date-this._openTime)}},this);this.playListCtrl.on("change:showList",function(newId){this.set("showlist",newId);if(this.get("open2load")<0){this.set("open2load",+new Date-this._openTime)}},this)},_setCurStatus:function(s){if(this.get("curStatus")===s)return;this.set("fromstart",this.stopwatches.playStart.getTime());this.set("fromload",this.stopwatches.loadLink.getTime());this.set("buftotal",this.stopwatches.bufTotal.getTime());this.set("bufc",this.stopwatches.bufCost.getTime());this.set("preStatus",this.get("curStatus"));this.set("curStatus",s);this.trigger("status:"+s,this)}});return StatsRecorder});
/** If u are interested in our code and would like to make it robust, just contact us^^  <enimong#gmail.com> **/
/** Generated by M3D. **/