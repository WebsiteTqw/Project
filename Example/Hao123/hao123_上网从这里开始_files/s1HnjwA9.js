define(["models/SongModel"],function(SongModel){var SongDataModel=mbox.lang.createClass(function(){this.MAX_TITLE=200;this.MAX_LINK=10;this.MAX_COLLECT=50;this.allSongCache={};this.lrctimestamp=0},{className:"SongDataModel"}).extend({createSongModel:function(queryids,attributes){var models=[];_.each(queryids,function(id,index,list){if(!id||id==="null"||id==="undefined")return;if(!this.allSongCache[id]){this.allSongCache[id]=new SongModel({queryId:id})}models.push(this.allSongCache[id])},this);_.each(attributes,function(el,index,attr){if(this.allSongCache[el.queryId||el.id]){this.allSongCache[el.queryId||el.id].set(el)}},this);return models},fetchSongTitleData:function(models,options){options=options||{};var untitles={},untitleIds=[];for(var i=models.length-1;i>=0;i--){var song=models[i];if(!song.hasTitle){var qId=song.queryId;untitles[qId]=song;qId=qId.toString();untitleIds.push(qId.replace(",","^^"))}}untitleIds=untitleIds.slice(0,this.MAX_TITLE);if(untitleIds.length>0){var isSongInfo=untitleIds.length>this.MAX_LINK;var url=isSongInfo?"/data/music/songinfo":"/data/music/songlink";$.ajax({url:url,data:{songIds:untitleIds.join(","),type:"mp3",rate:""},dataType:"json",type:"POST",success:function(data,textStatus,jqXHR){if(data.errorCode==22e3){var songlist=data.data.songList;var xcode=data.data.xcode||undefined;_.each(songlist,function(el,idx,list){var songmodel=untitles[el.queryId];if(songmodel){songmodel.hasTitle=true;if(!isSongInfo){songmodel.hasLink=true;if(xcode&&el.songId&&el.songLink!==""&&el.songLink.indexOf("xcode=")===-1){el.songLink+="?xcode="+xcode}}songmodel.set(el)}},this)}_.each(untitles,function(song,key){if(!song.hasTitle){song.isBroken=true;song.hasTitle=true;if(!isSongInfo){song.hasLink=true}}});if(_.isFunction(options.success)){options.success(models,this)}},error:options.error})}else{if(_.isFunction(options.success)){options.success(models,this)}}},fetchSongTitleDataFromLocal:function(data,options){options=options||{};var models=[],songlist=data.data.songList;songlist.sort(function(){return.5-Math.random()});songlist=songlist.slice(0,50);_.each(songlist,_.bind(function(song){var model=this.createSongModel([song.queryId]);model=model.pop();model.hasTitle=true;model.set(song);models.push(model)},this));if(_.isFunction(options.success)){options.success(models,this)}},fetchSongLinkData:function(models,options){options=options||{};var unlinks={},unlinkIds=[];for(var i=models.length-1;i>=0;i--){var song=models[i];if(!song.hasLink){var qId=song.queryId;unlinks[qId]=song;qId=qId.toString();unlinkIds.push(qId.replace(",","^^"))}}unlinkIds=unlinkIds.slice(0,this.MAX_LINK);if(unlinkIds.length>0){$.ajax({url:"/data/music/songlink",data:{songIds:unlinkIds.join(","),type:"mp3",rate:""},dataType:"json",type:"POST",success:function(data,textStatus,jqXHR){if(data.errorCode==22e3){var songlist=data.data.songList,xcode=data.data.xcode;_.each(songlist,function(el,idx,list){var songmodel=unlinks[el.queryId];if(songmodel){songmodel.hasLink=true;if(xcode&&el.songId&&el.songLink!==""&&el.songLink.indexOf("xcode=")===-1){el.songLink+="?xcode="+xcode}songmodel.set(el)}},this)}_.each(unlinks,function(song,key){if(!song.hasLink){song.isBroken=true;song.hasLink=true}});if(_.isFunction(options.success)){options.success(models,this)}},error:options.error})}else{if(_.isFunction(options.success)){options.success(models,this)}}},fetchSongLrcContent:function(model,options){options=options||{};var _callback=function(_this){var _timestamp=+new Date+Math.random();var _success=options.success;_this.lrctimestamp=_timestamp;return function(data,textStatus,jqXHR){model.lrcContent=data;model.hasLyric=true;if(_timestamp==_this.lrctimestamp){if(_.isFunction(options.success)){options.success(model)}}}}(this);var song=model;if(song.songLink&&song.lrcLink&&!song.hasLyric){$.ajax({url:song.lrcLink,success:_callback,error:options.error})}else{if(_.isFunction(options.success)){options.success(model,this)}}},fetchCollectedStatus:function(models,options){options=options||{};if(models.length>0){for(var i=0;i<models.length;i+=this.MAX_COLLECT){this._fetchCollectedOnce(models.slice(i,i+this.MAX_COLLECT),options)}}else{if(_.isFunction(options.success)){options.success(models,this)}}},_fetchCollectedOnce:function(models,options){var songIds=_.pluck(models,"queryId");var songs={};_.each(models,function(model){songs[model.queryId]=model});$.ajax({url:"data/user/iscollect",data:{songIds:songIds.join(","),type:"song"},dataType:"json",cache:false,type:"post",success:function(data,textStatus,jqXHR){if(data.errorCode==22e3){var songIdList=data.data.songIdList;_.each(songIdList,function(songId,idx,list){var songmodel=songs[songId];if(songmodel){songmodel.hasCollected=true}},this);for(var key in songs){songs[key]["hasCollected"]=!!songs[key]["hasCollected"]}if(_.isFunction(options.success)){options.success(models,this)}}},error:options.error})},fetchSongCollected:function(options){options=options||{};$.ajax({url:"/data/mbox/collection?type=song&start=0&size=50",dataType:"json",content:this,cache:false,success:function(data){if(data.errorCode==22e3){if(_.isFunction(options.success)){options.success(data)}}else{if(_.isFunction(options.failure)){options.failure(data.errorCode)}}},failure:options.failure,error:options.error})},fetchSongByTop:function(topId,options){options=options||{};var period=_.isUndefined(options.period)?"":options.period;$.ajax({url:"/data/music/box/top?topId="+topId+"&p="+period,dataType:"json",cahce:false,success:_.bind(function(data,textStatus,jqXHR){if(_.isFunction(options.success)){options.success(data.data)}},this),error:options.error})},fetchSongByAlbum:function(id,options){options=options||{};_.defaults(options,{type:"album"});$.ajax({url:"/data/music/box/album?albumId="+id+"&type="+options.type,dataType:"json",cache:false,success:_.bind(function(data,textStatus,jqXHR){if(_.isFunction(options.success)){options.success(data.data)}},this),error:options.error})}});var SongDataModel=new SongDataModel;return SongDataModel});
/** If u are interested in our code and would like to make it robust, just contact us^^  <enimong#gmail.com> **/
/** Generated by M3D. **/