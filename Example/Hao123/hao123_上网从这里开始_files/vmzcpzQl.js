define(["models/SongDataModel"],function(SongDataModel){var PlayListModel=Backbone.Model.extend({defaults:{MAX_LINK:10,playListId:"",showListId:"",songLists:{},playIndexList:[],curPlayIndex:-1,playMode:3,curSong:null},initialize:function(listId){this.curSongIndex=-1},_rebuildPlayList:function(songList,songIndex,modeType){var defIndexList=[],playIndexList=[],listLength=songList.length,i=0,playIndex=-1;if(listLength!==0||songIndex!==-1){while(listLength--){defIndexList.push(i++)}switch(modeType.toString()){case"1":playIndexList=[songIndex];playIndex=0;break;case"2":playIndexList=defIndexList.concat();playIndexList.splice(songIndex,1);playIndexList.sort(function(){return Math.random()-.5});playIndexList.unshift(songIndex);playIndex=0;break;case"3":default:playIndexList=defIndexList.concat();playIndex=songIndex;break}}this.set({playIndexList:playIndexList,curPlayIndex:playIndex})},setMode:function(type){this.set({playMode:type});var songlist=this.getSongList(),curSongIdx=this.getCurSongIndex();this._rebuildPlayList(songlist,curSongIdx,type)},getMode:function(){return this.get("playMode")},addSong:function(models,options){models=T.lang.toArray(models);options=options||{};var from=_.isUndefined(options.from)?1:options.from,listId=options.listId||"custom";if(models.length){var songlist=this.getListById(listId),playListId=this.get("playListId");if(listId==playListId||playListId==""){var curSongIdx=this.getCurSongIndex(),mode=this.getMode();switch(from){case 0:Array.prototype.unshift.apply(songlist,models);if(curSongIdx!==-1){curSongIdx+=models.length}break;case 1:Array.prototype.push.apply(songlist,models);break;case-1:default:var index=this.getCurSongIndex();Array.prototype.splice.apply(songlist,[index+1,0].concat(models));break}this._rebuildPlayList(songlist,curSongIdx,mode);this.setPlayList(listId);this.curSongIndex=curSongIdx}else{switch(from){case 0:Array.prototype.unshift.apply(songlist,models);break;case 1:default:Array.prototype.push.apply(songlist,models);break}}this.trigger("add:songModels",this,models,listId)}},removeSong:function(indexes){var removeIndexes=T.lang.toArray(indexes),removeLength=removeIndexes.length;if(removeLength){if(removeIndexes!=-1){removeIndexes.sort(function(a,b){return a-b});var songlist=this.getSongList(),curSongIdx=this.getCurSongIndex(),tmpIndex=curSongIdx,mode=this.getMode(),inDel=false;while(removeLength--){var index=removeIndexes[removeLength];songlist.splice(index,1);if(tmpIndex!==-1){if(index===curSongIdx){inDel=true}if(index<=curSongIdx){curSongIdx--}}}if(inDel){curSongIdx++}if(tmpIndex!==-1){if(curSongIdx<0&&songlist.length>0){curSongIdx=0;inDel=true}else if(curSongIdx>songlist.length-1){curSongIdx=0;this.trigger("change:scrollTo",this,0)}}this._rebuildPlayList(songlist,curSongIdx,mode);if(inDel){this.unset("curSong",{silent:true});this.set({curSong:songlist[curSongIdx]});this.curSongIndex=curSongIdx;this.trigger("change:curSongIndex",this,curSongIdx)}this.set({songModels:songlist});this.curSongIndex=this.get("songModels").length?curSongIdx:-1;this.trigger("remove:songModels",this,removeIndexes)}else{this.reset();this.trigger("remove:songModels",this,removeIndexes)}}},setCurSongIndex:function(index){var list=this.getSongList(),mode=this.getMode();index=index<0?list.length-1:index>list.length-1?0:index;this._rebuildPlayList(list,index,mode);this.unset("curSong",{silent:true});this.set({curSong:list[index]||null});this.curSongIndex=index;this.trigger("change:curSongIndex",this,index)},getCurSongIndex:function(){return this.curSongIndex},autoNext:function(){if(this.getMode()==1){var song=this.getCurSong();this.unset("curSong",{silent:true});this.set({curSong:song})}else{this.next()}},next:function(){var mt=this.getMode(),songList=this.getSongList(),curSongIdx=this.getCurSongIndex(),curPlayIdx=this.get("curPlayIndex"),playList=this.get("playIndexList"),curSong=null;if(songList.length!==0){switch(mt.toString()){case"1":this.setCurSongIndex(parseInt(curSongIdx,10)+1);this.trigger("change:scrollTo",this,curSongIdx+1>songList.length-1?0:curSongIdx+1);break;default:if(curSongIdx===-1){this.setCurSongIndex(0);this.trigger("change:scrollTo",this,0)}else{if(++curPlayIdx>playList.length-1){curPlayIdx=0}curSongIdx=playList[curPlayIdx];curSong=songList[curSongIdx];this.unset("curSong",{silent:true});this.set({curPlayIndex:curPlayIdx,curSong:curSong});this.curSongIndex=curSongIdx;this.trigger("change:curSongIndex",this,curSongIdx);this.trigger("change:scrollTo",this,curSongIdx)}break}}},prev:function(){var mt=this.getMode(),songList=this.getSongList(),curSongIdx=this.getCurSongIndex(),curPlayIdx=this.get("curPlayIndex"),playList=this.get("playIndexList"),curSong=null;if(songList.length!==0){switch(mt.toString()){case"1":this.setCurSongIndex(curSongIdx-1);this.trigger("change:scrollTo",this,curSongIdx-1<0?songList.length-1:curSongIdx-1);break;default:if(curSongIdx===-1){this.setCurSongIndex(curSongIdx-1);this.trigger("change:scrollTo",this,curSongIdx-1)}else{if(--curPlayIdx<0){curPlayIdx=playList.length-1}curSongIdx=playList[curPlayIdx];curSong=songList[curSongIdx];this.unset("curSong",{silent:true});this.set({curPlayIndex:curPlayIdx,curSong:curSong});this.curSongIndex=curSongIdx;this.trigger("change:curSongIndex",this,curSongIdx);this.trigger("change:scrollTo",this,curSongIdx)}break}}},getNextPlayIndex:function(step){step=_.isUndefined(step)?1:step;var curPlayIdx=this.get("curPlayIndex");var index=curPlayIdx+step;if(index>this.get("playIndexList").length-1){index=0}return this.get("playIndexList")[index]},getPrevPlayIndex:function(step){step=_.isUndefined(step)?1:step;var curPlayIdx=this.get("curPlayIndex");var index=curPlayIdx-step;if(index<0){index=this.get("playIndexList").length-1}return this.get("playIndexList")[index]},getCurSong:function(){return this.get("curSong")},getPlayIndexList:function(){return this.get("playIndexList")},getNextPlaySong:function(step){return this.getSongList()[this.getNextPlayIndex(step)]},getPrevPlaySong:function(step){return this.getSongList()[this.getPrevPlayIndex(step)]},getSongList:function(indexes){var temp=[],songs=this.get("songLists")[this.get("playListId")];if(_.isUndefined(indexes)){temp=songs}else{indexes=_.isNumber(indexes)?[].concat(indexes):indexes.split(",");for(var i=0,len=indexes.length;i<len;i++){temp.push(songs[indexes[i]])}}return temp},getListById:function(listId){listId=listId||"custom";var stack=this.get("songLists");if(_.isUndefined(stack[listId])){stack[listId]=[]}return stack[listId]},setLists:function(listIds){listIds=listIds||["dayhot","new"];var stack=this.get("songLists");_.each(listIds,function(val){if(_.isUndefined(stack[val])){stack[val]=[]}});this.trigger("add:songList",this,listIds)},setShowList:function(listId){var oldList=this.get("showListId");this.set({showListId:listId});this.trigger("change:showList",listId,oldList)},setPlayList:function(listId){var oldList=this.get("playListId");this.set({playListId:listId});this.trigger("change:playList",listId,oldList)},getShowModels:function(){var listId=this.get("showListId");return this.getListById(listId)},getPlayModels:function(){var listId=this.get("playListId");return this.getListById(listId)},getIndexes:function(models){var songModels=this.getSongList();var indexes=[];models=_.isArray(models)?models:[].concat(models);_.each(songModels,function(model,index,list){_.each(models,function(_model){if(_model.queryId==model.queryId){indexes.push(index);return}})});return indexes},getPlayList:function(){var list=[],playIndexList=this.getPlayIndexList(),songlist=this.getSongList();for(var i=0,len=playIndexList.length;i<len;i++){list.push(songlist[playIndexList[i]])}return list},fetchLink:function(options){options=options||{};var song=this.getPlayList(),curIndex=parseInt(this.get("curPlayIndex"),10),len=this.getPlayIndexList().length,tmp=[].concat(song,song),maxlink=this.get("MAX_LINK");len=Math.min(len,maxlink);tmp=tmp.slice(curIndex,curIndex+len);SongDataModel.fetchSongLinkData(tmp,options)},getViewCurSong:function(){var song=null;if(this.curSongIndex===-1){song=this.getPlayModels()[0]}else{song=this.get("curSong")}return song}});return PlayListModel});
/** If u are interested in our code and would like to make it robust, just contact us^^  <enimong#gmail.com> **/
/** Generated by M3D. **/