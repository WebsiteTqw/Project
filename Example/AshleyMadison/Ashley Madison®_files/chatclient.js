function get_unix_timestamp(){return parseInt((""+(new Date).getTime()).substring(0,10),10)}function initChat(){try{var e=!1;if("flash"==chatJson.chatType)if(!chatJson.largeChat&&10>swfobject.getFlashPlayerVersion().major){var t=chatJson.imagePrefix+"lang/"+chatJson.language+"/v2/private/chat/flash/",s={chatUrl:chatJson.chatUrl+"&style=classic",getFlashUrl:"http://www.adobe.com/go/getflashplayer",leftBannerImage:t+"date/banner_left.jpg",rightBannerImage:t+"banner_right.jpg"},n='<table border="0" cellpadding="0" cellspacing="0"><tr><td><a href="<%= getFlashUrl %>" target="_blank"><img src="<%= leftBannerImage %>" border="0"/></a></td><td><a href="<%= chatUrl %>"><img src="<%= rightBannerImage %>" border="0"/></a></td></tr></table>';$("#flashContainer").html(_.template(n,s))}else e=new SWFChatUI(chatJson);else e=new JSChatUI(_.pick(chatJson,["imagePrefix","summer","requestPnum","creditsUrl"]));chatClient=new ChatClient(chatJson),chatClient.init(e,window)}catch(i){chatJson.devMode&&"undefined"!=typeof console&&"function"==typeof console.log&&console.log(i.stack)}}function select_classic_chat(e){var t=chatJson.chatUrl;-1===t.indexOf("?")&&(t+="?"),t+="&style=classic&requestchat="+e,window.location.href=t}function escapeFlash(e){var t={"\\r":"%0D","\\t":"%09","\\f":"%0C","\\n":"%0A","\\b":"%08","\\\\":"%5C%5C","\\":"%5c",'"':"%22"},s=e;for(var n in t)for(var i=s.indexOf(n);i>-1;)s=s.replace(n,t[n]),i=s.indexOf(n);return s}function unescapeFlash(e){var t={"%0D":"\\r","%09":"\\t","%0C":"\\f","%0A":"\\n","%08":"\\b","%5C%5C":"\\\\","%5c":"\\","%22":'"'},s=e;for(var n in t)for(var i=s.indexOf(n);i>-1;)s=s.replace(n,t[n]),i=s.indexOf(n);return s}function doPanic(){SWFChatUtil.navigateTo("http://"+chatJson.panicUrl,!0)}function goClickForDetails(){SWFChatUtil.navigateTo("/app/private/support/faq.p#2")}function peopleSearch(){if(SWFChatUtil.isSmallChat())SWFChatUtil.navigateTo("/app/private/member/search/autosearch.p");else{var e="popup/search.p";$('<iframe src="'+e+'" scrolling="no"  frameBorder="0" height="384px" width="610px"></iframe>').appendTo("#chatSearchPopup"),$("#chatSearchPopup").jqm({ajax:e,target:"#chatSearchPopup iframe",modal:!0}),$("#chatSearchPopup").jqmShow()}}function goHelp(){var e="popup/tutorial.p?sid="+chatJson.sid;$('<iframe src="'+e+'" scrolling="no"  frameBorder="0" height="497px" width="871px"></iframe>').appendTo("#chatTutorialPopup"),$("#chatTutorialPopup").jqm({ajax:e,target:"#chatTutorialPopup iframe",modal:!0}),$("#chatTutorialPopup").jqmShow()}function closeHelp(){$("#chatTutorialPopup").jqmHide().html("")}function sendGift(e){chatClient.profiles.executeFor(e,function(e){if(SWFChatUtil.isSmallChat())SWFChatUtil.navigateTo("/app/private/member/gift/gift.p?id="+e.pnum);else{var t="popup/gift_send.p?id="+e.pnum;$('<iframe src="'+t+'" scrolling="no"  frameBorder="0" height="315px" width="610px"></iframe>').appendTo("#sendGiftPopup"),$("#sendGiftPopup").jqm({ajax:t,target:"#sendGiftPopup iframe",modal:!0}),$("#sendGiftPopup").jqmShow()}})}function viewProfile(e){chatClient.profiles.executeFor(e,function(e){SWFChatUtil.isSmallChat()?SWFChatUtil.navigateTo("/app/private/member/profile.p?id="+e.pnum):($("#viewProfilePopup").jqm({ajax:"popup/profile.p?id="+e.pnum,modal:!0,onLoad:function(){$(".close_button").click(function(){$("#viewProfilePopup").jqmHide().html("")})}}),$("#viewProfilePopup").jqmShow())})}function viewShowCase(e){chatClient.profiles.executeFor(e,function(e){SWFChatUtil.isSmallChat()?SWFChatUtil.navigateTo("/app/private/member/showcase.p?id="+e.pnum):($("#viewShowcasePopup").jqm({ajax:"popup/showcase.p?id="+e.pnum,modal:!0,onLoad:function(){$(".close_button").click(function(){$("#viewShowcasePopup").jqmHide().html("")})}}),$("#viewShowcasePopup").jqmShow())})}function viewGift(){SWFChatUtil.isSmallChat()?SWFChatUtil.navigateTo("/app/private/member/message/inbox.p"):SWFChatUtil.navigateTo("/app/private/site.p",!0)}function buyCredits(){SWFChatUtil.isSmallChat()?SWFChatUtil.navigateTo("/app/private/member/payment/optimalcc.p"):SWFChatUtil.navigateTo("/app/private/site.p?flcontext=buycredits",!0)}function removeUser(e){chatClient.removeTab(e),chatClient.saveState()}function revealMask(e){chatClient.sendMaskReveal(e)}function revokeMask(e){chatClient.sendMaskRevoke(e)}function setEnvironment(e,t){chatClient.sendEnvironment(e,t)}function requestEnvironment(e,t){chatClient.sendEnvironmentRequest(e,t)}function declineEnvironmentRequest(e){chatClient.sendEnvironmentRequestDeclined(e)}function loadRoster(){var e=[],t=chatClient.tabs();for(var s in t)t[s]instanceof Array&&(rosterItem={},rosterItem[s]={presence:chatClient.getLastPresence(s),showcase_granted:chatClient.showcaseGranted(s)?"true":"false"},e.push(rosterItem));return JSJaCJSON.toString(e)}function loadMessages(e){var t=_.clone(chatClient.tabs(e)).reverse()||[];return JSON.stringify(t)}function enterFullscreen(){parent.window.location="/app/private/chat/immersive.p"}function exitFullscreen(){parent.window.location="/app/private/site.p"}function flashReady(){isReady=!0}function isJsReady(){return!0}function thisMovie(e){return-1!=navigator.appName.indexOf("Microsoft")?window[e]:document[e]}function initChatSession(e,t){1>chatClient.timer()&&chatClient.profiles.executeFor(e,function(e){jQuery.post("ajax.p",{method:"initChatSession",pnum:e.pnum,"package":t},function(e){if(e.success&&parseInt(e.seconds,10)>0){var t=chatClient.timer()+parseInt(e.seconds,10);chatClient.timer(t)}},"json")})}function sendMessage(e,t){if(chatClient.isPaused()){var s=JSJaCJSON.toString({title:getLang("Paused"),message:getLang("Your session is currently paused. Please unpause to continue chatting.")});thisMovie(swfName).onEvent("alert_message",s)}else chatClient.profiles.executeFor(e,function(s){if(chatClient.blocklist.isBlocked(s.pnum)){var n=JSJaCJSON.toString({title:"",message:getLang("You currently have %s on your Block List.").replace(/%s/,e),usepopup:"false"});thisMovie(swfName).onEvent("alert_message",n)}else chatClient.sendMessage(e,unescapeFlash(t))})}function sendPreContact(e){chatClient.profiles.executeFor(e,function(e){$.post("ajax.p",{method:"sendPreContact",pnum:e.pnum},function(){},"json")})}function sendTypingNotify(e){chatClient.sendTypingNotify(e)}function pauseChatSessions(){chatClient.pause()}function unpauseChatSessions(){chatClient.unpause()}function sendCollect(e){chatClient.profiles.executeFor(e,function(e){$.post("ajax.p",{method:"sendCollect",pnum:e.pnum},function(){},"json")})}function sendCannedMessage(e,t){var s={can_1:1,can_2:2,can_3:3,can_4:4,can_5:5,can_6:6,can_7:7};s[t]>0&&chatClient.profiles.executeFor(e,function(e){$.post("ajax.p",{method:"sendCannedMessage",pnum:e.pnum,canId:s[t]},function(){},"json")})}function getProfileData(e){var t={};return chatClient.profiles.removeData(e),chatClient.profiles.executeFor(e,function(e){t.gender=e.gender,t.maskid=""+e.mask_id,t.maskX=""+e.mask_x,t.maskY=""+e.mask_y,t.maskWidth=""+e.mask_width,t.maskHeight=""+e.mask_height,t.maskRotation=""+e.mask_rotation,t.photo=e.photo_url_chat,t.thumbnail=e.photo_url_chat,t.cropX=""+e.crop_x,t.cropY=""+e.crop_y,t.cropWidth=""+e.crop_width,t.cropHeight=""+e.crop_height,t.environmentid=e.environment_id,t.self_mask_revealed=e.self_mask_revealed,t.buddy_mask_revealed=e.buddy_mask_revealed,t.showcase_granted=""+e.showcase_access},!1),JSJaCJSON.toString(t)}function enterWizard(){if(isReady)for(var e in chatClient.tabs())chatClient.sendEnteredWizard(e)}function setProfileData(e){var t=JSJaCJSON.parse(e);$.post("ajax.p",{method:"saveMask",photo_id:t.photoid,mask_id:t.maskid,mask_x:t.maskX,mask_y:t.maskY,mask_width:t.maskWidth,mask_height:t.maskHeight,mask_rotation:t.maskRotation,crop_x:t.cropX,crop_y:t.cropY,crop_width:t.cropWidth,crop_height:t.cropHeight},function(e){if(e.success)for(var t in chatClient.tabs())chatClient.sendProfileUpdated(t)},"json")}function toggleShowcase(e){$.post("ajax.p",{method:"toggleShowcase",nickname:e},function(e){chatClient.showcaseAccess(e.nickname,e.showcase_access)},"json")}function getChatTimer(){return chatClient.timer()}function setPresence(e){chatClient.setPresence(e)}function goChatSearch(){SWFChatUtil.isSmallChat()&&SWFChatUtil.navigateTo("/app/private/member/search/autosearch.p?chat_search=1")}function openpopupEnUs(){winpops=window.open(popurl,"","width=871,height=497,scrollbars=0,toolbar=0,location=0,statusbar=0,menubar=0,resizable=0,titlebar=yes")}function openpopup(e){var t,s,n,i=0,a=0,o=0,r=0,c=0,h=0,u="yes",l="";"en_US"==e?(t="popup/tutorial.p?sid="+chatJson.sid,s=871,n=497):(t=chatJson.flashPrefix+"htmlbuild/fantasydate_info_"+e+".html",s=951,n=507),l="width="+s+",height="+n+",scrollbars="+i+",toolbar="+a+",location="+o+",statusbar="+r+",menubar="+c+",resizable="+h+",titlebar="+u,winpops=window.open(t,"",l)}function openpopupEsUs(){openpopup("es_US")}function openpopupDeDe(){openpopup("de_DE")}function openpopupEsEs(){openpopup("es_ES")}function openpopupPtBr(){openpopup("pt_BR")}function openpopupItIt(){openpopup("it_IT")}var ChatUI=function(){this.type=null};ChatUI.prototype={setPresence:function(){throw"setPresence: not implemented"},logout:function(){throw"logout: not implemented"},addUser:function(){throw"addUser: not implemented"},onPresence:function(){throw"onPresence: not implemented"},onIq:function(){throw"onIq: not implemented"},onMessage:function(){throw"onMessage: not implemented"},onError:function(){throw"onError: not implemented"},onConnected:function(){throw"onConnected: not implemented"},onStatusChanged:function(){throw"onStatusChanged: not implemented"},init:function(){throw"init: not implemented"},typing:function(){throw"typing: not implemented"},setShowcase:function(){throw"setShowcase: not implemented"},showDialog:function(){throw"showDialog: not implemented"},addMessage:function(){throw"addMessage: not implemented"},addCannedMessage:function(){throw"addCannedMessage: not implemented"},requestImmersive:function(){},getCurrentTab:function(){throw"getCurrentTab: not implemented"}};var ChatUtil=function(){this.escapeMap=[["\\","\\5c"],[" ","\\20"],['"',"\\22"],["&","\\26"],["'","\\27"],["/","\\2f"],[":","\\3a"],["<","\\3c"],[">","\\3e"],["@","\\40"]]};ChatUtil.prototype={_replace:function(e,t){var s,n,i,a,o=t?1:0,r=t?0:1;for(s=0;this.escapeMap.length>s;s++)for(n=this.escapeMap[s][o],i=this.escapeMap[s][r],a=e.indexOf(n);a>-1;)e=e.replace(n,i),a=e.indexOf(n);return e},escapeJID:function(e){return this._replace(e)},unescapeJID:function(e){return this._replace(e,!0)},getUsernameFromJID:function(e){var t=e,s=t.split("@");return s.length>1&&(t=s[0]),this.unescapeJID(t)},createJID:function(e,t,s){var n=this.escapeJID(e);return t&&(n+="@"+t,s&&(n+="/"+s)),n}};var NS_ASHLEY_NOTIFY="ashley:iq:notify",sessionKeys=["presence","userTabs","lastPresence","showcaseGrants"],validPresences=["dnd","xa","away","chat"],chatClientOptions=["sid","username","password","domain","presence","showcase","paused","timeLeft","devMode","forcePolling","lowTraffic","sessionStore"],chatClientDefaults={showcase:!1,presence:"chat",paused:!1,timeLeft:0,_connection:null,ui:null,lastNotified:-1,lastTimerSync:0,lastReconnectTime:0,showcaseAccesses:{},showcaseGrants:{},lastPresence:{},pausing:!1,userTabs:{},subscriptions:{}},ChatClient=function(e){this.util=new ChatUtil,_.extend(this,_.pick(e,chatClientOptions)),_.defaults(this,chatClientDefaults),this.notify=new Notify(this),this.profiles=new Profiles(settings.maxCacheSize),this.blocklist=new BlockList,this.blocklist.setBlockList(e.blockedList),this.username=this.util.unescapeJID(this.username),this.resource="Ashley.Client",_.bindAll(this)};ChatClient.prototype={init:function(e,t){if(this.isClaimed()){var s=this;return setTimeout(function(){s.init(e,t)},1e3),void 0}this.restoreState(),t.onbeforeunload=this.unload,e&&(this.ui=e,e.client=this,e.init(),this.updateSessionCounter(),this.claim(),this.watchConnection(!0))},watchConnection:function(e){var t=get_unix_timestamp();settings.aborted||this.isConnected()||(e||t-settings.retryDelta>this.lastRetryTime())&&(this.connect(),this.lastRetryTime(t)),setTimeout(this.watchConnection,1e3*settings.retryDelta)},isConnected:function(){return this._connection!==void 0&&null!==this._connection&&this._connection.connected()},isClaimed:function(){var e=null;try{e=JSJaCCookie.read(this.username+".claimed").getValue()}catch(t){}return e&&e>get_unix_timestamp()?!0:!1},unload:function(){this.unClaim(),this.suspend()},getRoster:function(){var e=new JSJaCIQ;e.setFrom(this.util.createJID(this.username,this.domain,this.resource)),e.setType("get"),e.setQuery("jabber:iq:roster"),this._connection.send(e)},addRoster:function(e){if(this.subscriptions[e]!==!0){var t=new JSJaCPresence;t.setTo(this.util.createJID(e,this.domain)),t.setType("subscribe"),this._connection.send(t)}},confirmRoster:function(e){var t=new JSJaCPresence;t.setTo(this.util.createJID(e,this.domain)),t.setType("subscribed"),this._connection.send(t)},sendDND:function(e){this._sendIQNotify(e,"do_not_disturb","")},sendEnteredWizard:function(e){this._sendIQNotify(e,"entered_wizard","")},requestImmersive:function(e){this._sendIQNotify(e,"request_immersive","")},sendProfileUpdated:function(e){this._sendIQNotify(e,"profile_updated","")},sendTypingNotify:function(e){this._sendIQNotify(e,"is_typing","")},sendEnvironment:function(e,t){var s=this;s.profiles.executeFor(e,function(n){$.post("ajax.p",{method:"setEnvironment",pnum:n.pnum,environment_id:t},function(n){n.success&&s._sendIQNotify(e,"environment_changed",t)},"json")})},sendEnvironmentRequest:function(e,t){this._sendIQNotify(e,"request_environment",t)},sendEnvironmentRequestDeclined:function(e){this._sendIQNotify(e,"request_environment_declined","")},sendMaskRevoke:function(e){var t=this;t.profiles.executeFor(e,function(s){$.post("ajax.p",{method:"revokeMask",pnum:s.pnum},function(s){s.success&&t._sendIQNotify(e,"mask_revoke","")},"json")})},sendMaskReveal:function(e){var t=this;t.profiles.executeFor(e,function(s){$.post("ajax.p",{method:"revealMask",pnum:s.pnum},function(s){s.success&&t._sendIQNotify(e,"mask_reveal","")},"json")})},_sendIQNotify:function(e,t,s){var n=new JSJaCIQ;n.setFrom(this.util.createJID(this.username,this.domain,this.resource)),n.setTo(this.util.createJID(e,this.domain,this.resource)),n.setType("set");var i=n.setQuery(NS_ASHLEY_NOTIFY);i.setAttribute("type",t),i.setAttribute("params",s),this._connection.send(n)},togglePause:function(){this.paused?this.unpause():this.pause()},isPaused:function(){return this.paused},pause:function(){var e=this;e.pausing||(e.pausing=!0,e.paused=!0,e.ui.setPausedIcon(),$.post("ajax.p",{method:"pauseChatSessions"},function(t){e.pausing=!1,t.success||e.ui.setPausedIcon()},"json"))},unpause:function(){var e=this;e.pausing||(e.pausing=!0,e.paused=!1,e.ui.setPausedIcon(),$.post("ajax.p",{method:"unpauseChatSessions"},function(t){e.pausing=!1,t.success||e.ui.setPausedIcon()},"json"))},timer:function(e){return arguments.length>0&&(this.timeLeft=e),this.timeLeft},lastNotifyInterval:function(e){return arguments.length&&(this.lastNotified=e),this.lastNotified},lastRetryTime:function(e){return arguments.length&&(this.lastReconnectTime=e),this.lastReconnectTime},hasShowcase:function(){return this.showcase},showcaseAccess:function(e,t){return arguments.length>1&&(this.showcaseAccesses[e]=t),this.showcaseAccesses[e]||0},tabs:function(e){return arguments.length?this.userTabs[e]||[]:this.userTabs},removeTab:function(e){delete this.userTabs[e]},_connectionFactory:function(e,t){var s=null;if(this.devMode){var n=new JSJaCConsoleLogger(3);t.oDbg=n}return s=e?new JSJaCHttpPollingConnection(t):new JSJaCHttpBindingConnection(t)},connect:function(){try{if(this._connection=this._connectionFactory(this.forcePolling),this.registerHandlers(),this._connection.resume())return!0;delete this._connection}catch(e){}var t=90;$("html").hasClass("chrome")&&(t=1);var s={httpbase:"/http-bind/",timerval:2e3,wait:t};this.forcePolling&&(s.httpbase="/http-poll/"),this._connection=this._connectionFactory(this.forcePolling,s),this.registerHandlers();var n={domain:this.domain,username:this.util.escapeJID(this.username),pass:this.password,resource:this.resource,register:!1,wait:t};this._connection.connect(n),this._connection.registerIQGet("query",NS_VERSION,this.onIqVersion),this._connection.registerIQGet("query",NS_TIME,this.onIqTime)},suspend:function(){try{this.unregisterHandlers()}catch(e){}this._connection.suspend()},getPresence:function(){return this.presence},setPresence:function(e){if(this.isValidPresence(e)){this.presence=e,this.ui.setPresence(e),this.saveState();try{var t=new JSJaCPresence;return t.setShow(e),this._connection.send(t),!0}catch(s){}}return!1},getLastPresence:function(e){return this.lastPresence[e]||"chat"},showcaseGranted:function(e,t){return arguments.length>1&&(this.showcaseGrants[e]=t),this.showcaseGrants[e]||!1},registerHandlers:function(){return this._connection.registerHandler("message",this.onMessage),this._connection.registerHandler("presence",this.onPresence),this._connection.registerHandler("iq",this.onIq),this._connection.registerHandler("onconnect",this.onConnected),this._connection.registerHandler("onerror",this.onError),this._connection.registerHandler("status_changed",this.onStatusChanged),this._connection.registerHandler("ondisconnect",this.onDisconnected),this._connection.registerHandler("onresume",this.onResume),!0},unregisterHandlers:function(){return this._connection.unregisterHandler("message",this.onMessage),this._connection.unregisterHandler("presence",this.onPresence),this._connection.unregisterHandler("iq",this.onIq),this._connection.unregisterHandler("onconnect",this.onConnected),this._connection.unregisterHandler("onerror",this.onError),this._connection.unregisterHandler("status_changed",this.onStatusChanged),this._connection.unregisterHandler("ondisconnect",this.onDisconnected),this._connection.unregisterHandler("onresume",this.onResume),!0},onConnected:function(){this.getRoster(),this._connection.send(new JSJaCPresence),this.setPresence(this.presence),this.ui.onConnected()},onDisconnected:function(){},onResume:function(){this.ui.onResume()},onStatusChanged:function(e){"session-terminate-conflict"==e&&(settings.aborted=!0),this.ui.onStatusChanged(e)},onError:function(e){this._connection.connected()&&this._connection.disconnect();var t=e.getAttribute("code"),s=e.getAttribute("type"),n=e.firstChild.nodeName;this.ui.onError(t,s,n)},onMessage:function(e){var t=this,s=this.util.getUsernameFromJID(e.getFrom()),n=this.util.getUsernameFromJID(e.getTo()),i=e.getBody();return e.isError()?(this.ui.onPresence(s,"offline"),!1):("dnd"==this.presence?this.sendDND(s):e.getBody().length&&s.toLowerCase()!=this.username.toLowerCase()&&t.profiles.executeFor(s,function(e){t.blocklist.isBlocked(e.pnum)||(t.addRoster(e.nickname),t.ui.onMessage(e.nickname,i,e),t._logAction(e.nickname,n,"message",i))}),!0)},onIq:function(e){var t=this.util.getUsernameFromJID(e.getFrom()),s=e.getQueryXMLNS(),n=e.getQuery(),i=this;if(!e.isError())switch(s){case NS_ROSTER:$(e.xml()).find("item").each(function(){"both"==$(this).attr("subscription")&&(buddyNickname=i.util.getUsernameFromJID($(this).attr("jid")),i.subscriptions[buddyNickname]=!0)});break;case NS_ASHLEY_NOTIFY:var a=n.getAttribute("type"),o=n.getAttribute("params");this.notify.process(a,t,o);break;default:this._connection.send(e.errorReply(ERR_FEATURE_NOT_IMPLEMENTED))}},onPresence:function(e){var t=this.util.getUsernameFromJID(e.getFrom()),s=e.getType(),n=e.getShow();if("subscribe"==s)this.confirmRoster(t);else if("subscribed"!=s||this.subscriptions[t]){var i="";if(s||n)if("unavailable"==s)i="offline";else switch(n){case"xa":i="away";break;case"away":case"dnd":case"chat":i=n}else i="online";var a=this;t.toLowerCase()!=this.username.toLowerCase()&&this.profiles.executeFor(t,function(e){a.lastPresence[e.nickname]!=i&&(a.lastPresence[e.nickname]=i,a.ui.onPresence(e.nickname,i),a._logAction(e.nickname,this.username,"presence",i))})}else this.confirmRoster(t),this.subscriptions[t]=!0},requestChat:function(e,t){var s=this;s._connection.connected()&&s.profiles.executeForPnum(e,function(e){this.username!=e.nickname&&(s.addUser(e.nickname),s.ui.addUser(e.nickname,e.showcase_access,t))})},logout:function(){this._connection.disconnect(),this.ui.logout()},sendMessage:function(e,t){this.addRoster(e);var s=new JSJaCMessage;s.setTo(this.util.createJID(e,this.domain)),s.setBody(t),this._connection.send(s),this._logAction(this.username,e,"message",t)},hasUser:function(e){return this.userTabs[e]!==void 0?!0:!1},addUser:function(e){this.userTabs[e]instanceof Array||(this.userTabs[e]=[],this.saveState())},saveState:function(){var e=this;_.each(this.userTabs,function(t,s){void 0===e.showcaseGrants[s]&&e.profiles.executeFor(s,function(t){e.showcaseGrants[s]=t.showcase_access},!1)});var t={key:this.sid,updated:get_unix_timestamp(),json:_.pick(this,sessionKeys)};this.sessionStore.save(t)},isValidPresence:function(e){return _.contains(validPresences,e)},restoreState:function(){var e,t=this.sessionStore;t.get(this.sid,function(t){e=t&&t.json?t.json:{}}),t.each(function(e){get_unix_timestamp()-3600>e.updated&&t.remove(e.key)}),e=_.defaults(e,{presence:"chat",userTabs:{},lastPresence:{},showcaseGrants:{}}),_.extend(this,_.pick(e,sessionKeys))},_logAction:function(e,t,s,n){var i={from:e,to:t,type:s,content:n,timestamp:this.getMessageTime()},a=e;e==t?a=this.ui.getCurrentTab():e==this.username&&(a=t),this.userTabs[a]instanceof Array||this.addUser(a),this.userTabs[a].length>=settings.historyLimit&&(this.userTabs[a]=this.userTabs[a].slice(-(settings.historyLimit-1))),this.userTabs[a].push(i),this.saveState()},unClaim:function(){var e=this.username+".claimed";try{new JSJaCCookie(e,""+(get_unix_timestamp()-1),get_unix_timestamp()-1).write()}catch(t){}},claim:function(){if(this.username.length){var e=this.username+".claimed",t=get_unix_timestamp()+settings.reclaimDelta+2+"";try{new JSJaCCookie(e,t).write()}catch(s){}}setTimeout(this.claim,1e3*settings.reclaimDelta)},getMessageTime:function(){var e=new Date,t=e.getHours(),s=e.getMinutes();return t>=0&&9>=t&&(t="0"+(""+t)),s>=0&&9>=s&&(s="0"+(""+s)),t+":"+s},updateSessionCounter:function(){if(!this.isPaused()){var e=get_unix_timestamp(),t=this;if(e-this.lastTimerSync>settings.updateCounterDeltaResync)$.post("ajax.p",{method:"getChatTimer"},function(e){t.timer(parseInt(e.seconds,10))},"json"),this.lastTimerSync=e;else{var s=this.timer()-settings.updateCounterDelta;0>=s&&(s=0,this.lastNotifyInterval(-1)),this.timer(s)}var n=this.timer();if(0===n)this.ui.hidePause();else{this.ui.showPause();var i=this.lastNotifyInterval();for(var a in settings.notifyAtMins)if(60*settings.notifyAtMins[a]>=n&&a>i){this.ui.addTimeNotice(Math.round(n/60)),this.lastNotifyInterval(a);break}}this.ui.setPausedTitle()}setTimeout(this.updateSessionCounter,1e3*settings.updateCounterDelta)}},$(function(){if("flash"===chatJson.chatType&&!chatJson.largeChat&&top.frames.headerchat===void 0)return top.location=chatJson.home,void 0;var e=null,t=["dom","userdata"];for(var s in t)try{e=new Lawnchair({table:"sessions",adaptor:t[s]});break}catch(n){}chatJson.sessionStore=e,initChat()});var settings={updateCounterDelta:1,updateCounterDeltaResync:180,notifyAtMins:[10,5,2],maxCacheSize:40,reclaimDelta:5,retryDelta:5,aborted:!1,maxMessageSize:1e3,showcaseTimer:1e3,typingNotifyTimer:2,typingReceiveTimer:5,historyLimit:30},chatClient=null,Messages=function(e){this.map={can_1:getLang("%user: Yes! I'm available - Please initiate an Instant Message Session."),can_2:getLang("%user: Sorry! I am online, but unable to chat with you right now. Please try again soon."),can_3:getLang("%user: I will contact you as soon as I buy credits."),can_4:getLang("%user: I will instant message you soon."),can_5:getLang("%user: Sorry! I Don't Accept Collect Messages."),can_6:getLang("%user: I'm not interested. Good luck!"),can_7:getLang("%user: Sorry, no credits! Will you please start a chat session?"),show_grant_r:getLang("Access to %user's %showcase_link has been granted."),show_grant_s:getLang("%user's access to your Private Showcase has been granted."),show_revoke_r:getLang("Access to %user's Private Showcase has been revoked."),show_revoke_s:getLang("%user's  access to your Private Showcase has been revoked."),gift_notify_r:getLang("%gift_img <b>You have received a gift!</b> %gift_link"),gift_notify_s:getLang("%user has received your gift."),chat_initiated:getLang("Your chat session has been initiated."),do_not_disturb:getLang("%user's status is currently set to do not disturb."),status_online:getLang("%user has come online."),status_offline:getLang("%user has gone offline."),status_away:getLang("%user has set their status to away."),status_dnd:getLang("%user has set their status to do not disturb."),status_chat:getLang("%user has set their status to available."),message:"%user: %message",profile:getLang("To view %user's profile, click <a href='%profile_link' target='main'>here</a>."),profile_upgraded:getLang("Membership updated.")},e&&(delete this.map.can_1,delete this.map.can_3,delete this.map.can_5,delete this.map.can_7)};Messages.prototype={format:function(e,t){var s="";if(void 0!==this.map[e]){s=this.map[e];for(var n in t)switch(n){case"containerClass":s='<div class="'+t[n]+'">'+s+"</div>";break;case"user":var i=t[n];void 0!==t.userClass&&(i='<span class="'+t.userClass+'">'+i+"</span>"),s=s.replace("%user",i);break;case"userClass":break;case"message":s=s.replace("%"+n,t[n]).htmlEnc();break;default:s=s.replace("%"+n,t[n])}}return s}};var Notify=function(e){this.client=e};Notify.prototype={factory:function(e,t,s){var n=NotifyBase;switch(e){case"collect_message":case"paused_session":case"no_session":case"pre_contact":n=DialogNotify;break;case"canned_message":case"grant_showcase":case"revoke_showcase":case"send_gift":case"send_gift_done":case"chat_initiated":case"revoke_showcase_done":case"grant_showcase_done":case"do_not_disturb":case"profile_upgraded":n=MessageNotify;break;case"presence_changed":n=PresenceChangedNotify;break;case"showcase_changed":n=ShowcaseChangedNotify;break;case"is_typing":n=IsTypingNotify;break;case"request_immersive":n=RequestImmersiveNotify;break;case"entered_wizard":n=EnterWizardNotify;break;case"mask_reveal":n=MaskNotify,s=!1;break;case"mask_revoke":n=MaskNotify,s=!0;break;case"environment_changed":n=EnvironmentNotify;break;case"profile_updated":n=ProfileUpdatedNotify;break;case"request_environment":n=EnvironmentRequest;break;case"request_environment_declined":n=EnvironmentRequestDeclined}return new n(this.client,e,t,s)},process:function(e,t,s){this.factory(e,t,s).process()}};var NotifyBase=function(e,t,s,n){this.client=e,this.type=t,this.nickname=s,this.params=n};NotifyBase.prototype={process:function(){},callUi:function(e){var t=this.client.ui;_.isFunction(t[e])&&t[e].apply(t,_.toArray(arguments).slice(1))}},NotifyBase.extend=function(e,t){var s,n=this;s=e&&_.has(e,"constructor")?e.constructor:function(){return n.apply(this,arguments)},_.extend(s,n,t);var i=function(){this.constructor=s};return i.prototype=n.prototype,s.prototype=new i,e&&_.extend(s.prototype,e),s.__super__=n.prototype,s};var MessageNotify=NotifyBase.extend({process:function(){var e=this.callUi("getCurrentTab"),t="";return"canned_message"==this.type&&(t="can_"+this.params),"revoke_showcase_done"==this.type&&this.client.showcaseGranted(this.nickname,!1),"grant_showcase_done"==this.type&&this.client.showcaseGranted(this.nickname,!0),e&&this.client._logAction(this.nickname,this.client.username,this.type,t),this.callUi("messageNotify",this.type,this.nickname,this.params)}}),DialogNotify=NotifyBase.extend({process:function(){var e="";switch(this.type){case"collect_message":case"paused_session":case"no_session":case"pre_contact":e=this.type}if("collect_message"==e&&this.client.isPaused()&&(e="collect_message_paused"),e.length)if("dnd"!=this.client.getPresence()||"collect_message"!=this.type&&"canned_message"!=this.type&&"pre_contact"!=this.type){var t=this;if(("no_session"==e||"paused_session"==e)&&chatJson.fSummer)return this.client.profiles.executeFor(this.nickname,function(e){$.post("ajax.p",{method:"sendCollect",pnum:e.pnum},function(){},"json")}),void 0;this.client.profiles.executeFor(this.nickname,function(s){t.client.hasUser(s.nickname)&&(t.client.addUser(s.nickname),t.callUi("addUser",s.nickname,s.showcase_access)),t.callUi("showDialog",e,s.nickname)})}else this.client.sendDND(this.nickname)}}),PresenceChangedNotify=NotifyBase.extend({process:function(){this.client.setPresence(this.params)}}),ShowcaseChangedNotify=NotifyBase.extend({process:function(){var e=parseInt(this.params,10)?!0:!1;this.callUi("setShowcase",e)}}),IsTypingNotify=NotifyBase.extend({process:function(){this.callUi("typing",this.nickname)}}),RequestImmersiveNotify=NotifyBase.extend({process:function(){this.callUi("requestImmersive",this.nickname)}}),EnterWizardNotify=NotifyBase.extend({process:function(){this.callUi("enteredWizard",this.nickname)}}),MaskNotify=NotifyBase.extend({process:function(){this.callUi("onMaskChanged",this.nickname,this.params)}}),ProfileUpdatedNotify=NotifyBase.extend({process:function(){this.callUi("profileUpdated",this.nickname)}}),EnvironmentNotify=NotifyBase.extend({process:function(){this.callUi("onEnvironmentChanged",this.nickname,this.params)}}),EnvironmentRequest=NotifyBase.extend({process:function(){this.callUi("onEnvironmentRequested",this.nickname,this.params)}}),EnvironmentRequestDeclined=NotifyBase.extend({process:function(){this.callUi("onEnvironmentRequestDeclined",this.nickname)}}),Profiles=function(e){this.base=Cache,this.base(e),this.prototype=new Cache};Profiles.prototype={removeData:function(e){this.prototype.items[e]!==void 0&&this.prototype._removeItem(e)},executeFor:function(e,t,s){var n=this.prototype.getItem(e);"__moreInfo__"===e&&(n={}),n?t(n):this._executeFor("nickname",e,t,s)},executeForPnum:function(e,t,s){for(var n in this.prototype.items)if(this.prototype.items[n].pnum==e)return t(this.prototype.getItem(this.prototype.items[n].nickname)),void 0;this._executeFor("pnum",e,t,s)},_executeFor:function(e,t,s,n){if("pnum"!=e&&"nickname"!=e)return null;var i=this,a={};a.method="getProfileData",a[e]=t;var o=function(e){if(e.success){var t={expirationAbsolute:null,expirationSliding:3600,priority:CachePriority.Normal};i.prototype.setItem(e.nickname,e,t),s(e)}},r={type:"POST",url:"/app/private/chat/ajax.p",data:a,success:o,async:n===!1?!1:!0,dataType:"json"};$.ajax(r)}};var BlockList=function(){this.blocklist={}};BlockList.prototype={setBlockList:function(e){this.blocklist=e},isBlocked:function(e){return this.blocklist[e]!==void 0?!0:!1},add:function(e){return this.blocklist[e]=!0,!0},remove:function(e){return this.blocklist[e]!==void 0&&delete this.blocklist[e],!0},removeList:function(e){for(var t in e)this.remove(e[t]);return!0},empty:function(){this.blocklist={}}};var jsChatOptions=["imagePrefix","creditsUrl","requestPnum","summer"],JSChatUI=function(e){this.type="javascript",_.extend(this,_.pick(e,jsChatOptions)),this.tabs=new Tabs(this),this.screens=new Screens(this),this.emoticons=new Emoticons(this.imagePrefix),this.messages=new Messages(this.summer),this.client=null,_.bindAll(this),this.setup()};_.extend(JSChatUI.prototype,ChatUI,{setup:_.once(function(){this.debounceHidePencil=_.debounce(this.hidePencilIcon,1e3*settings.typingReceiveTimer),this.sendTypingNotify=_.throttle(this.sendTypingNotify,1e3*settings.typingNotifyTimer)}),sendTypingNotify:function(){this.client.sendTypingNotify(this.tabs.getCurrentTab())},hidePause:function(){$("#chatPause").parent().hide()},showPause:function(){$("#chatPause").parent().show()},addTimeNotice:function(e){this.addMessage(this.tabs.getCurrentTab(),'<div class="sysMsg">'+getLang("%s minutes remaining.").replace(/%s/,e)+' <a href="'+this.creditsUrl+'" target="main">['+getLang("Buy credits now")+"]</a>.</div>")},getCurrentTab:function(){return this.tabs.getCurrentTab()},init:function(){for(var e in this.client.tabs())this.tabs.addTab(e,"",!0);
this.tabs.setCurrentTab("__moreInfo__"),$("#chatMessage").attr("maxlength",settings.maxMessageSize),this.registerPageEvents(),this.restoreTabs(),(!this.client.hasShowcase()||this.client.lowTraffic)&&$("#chatPrivatekey").parent().hide(),0===this.client.timer()&&$("#chatPause").parent().hide(),$("#clientContainer").show(),this.screens.setCurrent("chatClient"),$("#chatMessage").focus(),this.setPausedIcon(),this.setPausedTitle(),this.setPresenceIcon()},registerPageEvents:function(){var e=this;$("#sendMessage").click(function(){e.sendMessage($("#chatMessage"))}),$("#chatMessage").keypress(function(t){return 13==t.keyCode?(e.sendMessage($("#chatMessage")),!1):(e.sendTypingNotify(),void 0)}),$("#chatPause").click(function(){e.client.togglePause()}),$("#chatEmoticon").click(function(){$("#presenceScreen").hide(),$("#emoticonScreen").toggle()}),$("#chatPresence").click(function(){$("#emoticonScreen").hide(),$("#presenceScreen").toggle()}),$("#chatGift").click(function(){""!==e.tabs.getCurrentTab()&&e.client.profiles.executeFor(e.tabs.getCurrentTab(),function(e){window.open(e.gift_url,"main")})}),$("#chatPrivatekey").click(_.throttle(function(){""!==e.tabs.getCurrentTab()&&$.post("ajax.p",{method:"toggleShowcase",nickname:e.tabs.getCurrentTab()},function(t){e.client.showcaseAccess(t.nickname,t.showcase_access),e.tabs.getCurrentTab()==t.nickname&&e.setShowcaseIcon(t.nickname)},"json")},settings.showcaseTimer)),$(".emoticonS1,.presenceS3").hover(function(){$(this).addClass("iconHover")},function(){$(this).removeClass("iconHover")}),$(".emoticonS2").click(function(){$("#emoticonScreen").toggle(),$("#chatMessage").val($("#chatMessage").val()+$(this).attr("title")),$("#chatMessage").focus()}),$(".presenceS3").click(function(){$("#presenceScreen").toggle(),e.client.setPresence($(this).attr("title"))}),jQuery("#chatTabs").click(function(){e.tabs.toggleTabs()}),jQuery(".tabBar").click(function(){e.tabs.toggleTabs()}),$("#tabs").sortable({stop:function(){$(".closeTab").click(function(){var e=$(this).parent().attr("id").replace(/^tab_/,"");chatClient.ui.tabs.removeTab(e)})}})},sendMessage:function(e){var t=this.tabs.getCurrentTab(),s=this;return!this.tabs.isSpecialTab(t)&&e.val().length&&t.length&&this.client.profiles.executeFor(t,function(n){if(s.client.isPaused())s.addMessage(t,'<div class="sysMsg">'+getLang("You are currently paused. You must unpause before sending a message.")+"</div>");else if(s.client.blocklist.isBlocked(n.pnum))s.addMessage(t,'<div class="sysMsg">'+getLang("You currently have %s on your Block List.").replace(/%s/,t)+"</div>");else if("dnd"==s.client.getPresence())s.addMessage(t,'<div class="sysMsg">'+getLang("You are currently in do not disturb mode. Please change your status to continue chatting.")+"</div>");else try{return s.client.sendMessage(t,e.val().substr(0,settings.maxMessageSize)),s.addMessage(t,'<span class="chatSend">'+s.client.username+":</span> "+s.emoticons.replaceText(e.val().substr(0,settings.maxMessageSize).htmlEnc())),e.val(""),!0}catch(i){return s.client.debug(t+" "+(""+i)),!1}}),!1},restoreTabs:function(){var e={},t=this;e=this.client.tabs();for(var s in e)this.tabs.addTab(s,"");""!==this.tabs.getCurrentTab()&&this.client.profiles.executeFor(this.tabs.getCurrentTab(),function(e){t.client.showcaseAccess(e.nickname,e.showcase_access),t.setShowcaseIcon(t.tabs.getCurrentTab())})},addCannedMessage:function(e,t){var s=this;this.client.profiles.executeFor(e,function(n){var i="/app/private/member/profile.p?id="+n.pnum;i='<a target="main" href="'+i+'">'+e+"</a>";var a={user:i,userClass:"chatReceive"};s.client.ui.addMessage(e,s.messages.format(t,a))})},_addMessageRaw:function(e,t){$(e).find(".logPadder").append('<div class="message">'+t+"</div>"),this.tabs.scrollEnd(e,!0)},addMessage:function(e,t){if(!this.tabs.isSpecialTab(e)&&t.length)try{this.tabs.addTab(e,"",!1);var s=$(this.tabs.getId("#tab_",e));this._addMessageRaw(this.tabs.getId("#chatLog_",e),t);var n;s.hasClass("ui-sortable-helper")?n=s:(n=s.clone(!0),s.remove(),n.prependTo("#tabs")),this.tabs.getCurrentTab()!=e&&n.find(".name").css("opacity","1.0").fadeOut(function(){$(this).parent().addClass("changed"),$(this).fadeIn()})}catch(i){}},setShowcase:function(e){e?$("#chatPrivatekey").parent().show():$("#chatPrivatekey").parent().hide()},setShowcaseIcon:function(e){var t="";this.client.hasShowcase()&&(this.client.showcaseAccess(e)?(t=$("#chatPrivatekey").attr("src").replace(/(icon-privatekey(-large)?)\.gif/,"$1-revoke.gif"),"__moreInfo__"!=e?$("#chatPrivatekey").attr("title",getLang("Revoke my private key from %s").replace(/%s/,e)):$("#chatPrivatekey").attr("title",getLang("profilemanagement.photos.revokeprivatekey"))):(t=$("#chatPrivatekey").attr("src").replace(/-revoke/,""),"__moreInfo__"!=e?$("#chatPrivatekey").attr("title",getLang("Send my private key to %s").replace(/%s/,e)):$("#chatPrivatekey").attr("title",getLang("profilemanagement.photos.sendprivatekey"))),$("#chatPrivatekey").attr("src",t))},setPausedIcon:function(){var e="";e=this.client.isPaused()?$("#chatPause").attr("src").replace(/(icon-pause(-large)?)\.gif/,"$1-on.gif"):$("#chatPause").attr("src").replace(/-on/,""),$("#chatPause").attr("src",e)},setPausedTitle:function(){var e,t=this.client.timer();if(t){var s=Math.floor(t/60),n=t%60;10>s&&(s="0"+s),10>n&&(n="0"+n),e=getLang("Pause - %s remaining.").replace(/%s/,s+":"+n)}else e=getLang("Pause - No time remaining.");$("#chatPause").attr("title",e)},setPresenceIcon:function(){var e=this.client.getPresence();"xa"==this.client.getPresence()&&(e="away");var t=$(".presenceS3[title="+e+"] .presenceS2").css("background-image").replace(/url\(\"?([^()"]*)\"?\)/,"$1");$("#chatPresence").attr("src",t)},onStatusChanged:function(){},onConnected:function(){$(".chatScreen[name=no_server]").remove(),$(".chatScreen[name=not_authorized]").remove(),this.requestPnum&&chatClient.requestChat(this.requestPnum,!1)},onResume:function(){this.onConnected()},onError:function(e){"401"==e&&this.screens.showDialog("not_authorized","")},onMessage:function(e,t,s){this.hidePencil(!0);var n="/app/private/member/profile.p?id="+s.pnum;n='<span class="chatReceive"><a target="main" href="'+n+'">'+e+"</a></span>: ",this.addMessage(e,n+this.emoticons.replaceText(t.htmlEnc()))},onPresence:function(e,t){if(this.tabs.hasTab(e)){var s=null;if(t&&(s="status_"+t,null!==s)){var n={user:e,containerClass:"sysMsg"};this.addMessage(e,this.messages.format(s,n))}}},addUser:function(e,t){this.client.showcaseAccess(e,t),this.tabs.addTab(e,"",!1),this.tabs.setCurrentTab(e)},logout:function(){},setPresence:function(){this.setPresenceIcon()},typing:function(e){this.tabs.getCurrentTab()==e&&this.showPencil()},showDialog:function(e,t){this.screens.showDialog(e,t)},messageNotify:function(e,t,s){var n="",i={user:t};switch(e){case"canned_message":return n="can_"+s,this.client.ui.addCannedMessage(t,n),!0;case"grant_showcase":n="show_grant_r";var a="/app/private/member/showcase.p?id="+s;i.showcase_link='<a target="main" href="'+a+'">['+getLang("Private Showcase")+"]</a>",i.containerClass="sysMsg";break;case"revoke_showcase":n="show_revoke_r",i.containerClass="sysMsg";break;case"send_gift":n="gift_notify_r",i.gift_img='<img src="'+this.imagePrefix+'v2/private/chat/icon_giftmessage.gif" border="0" />';var o="/app/private/member/message/inbox.p";i.gift_link='<a target="main" href="'+o+'">'+getLang("Click here to see it.")+"</a>",i.containerClass="gift_notify_r";break;case"send_gift_done":n="gift_notify_s",i.containerClass="sysMsg";break;case"chat_initiated":n="chat_initiated",i.containerClass="sysMsg";break;case"revoke_showcase_done":n="show_revoke_s",i.containerClass="sysMsg",this.client.showcaseAccess(t,0),this.client.ui.tabs.getCurrentTab()==t&&this.client.ui.setShowcaseIcon(t);break;case"grant_showcase_done":n="show_grant_s",i.containerClass="sysMsg",this.client.showcaseAccess(t,1),this.client.ui.tabs.getCurrentTab()==t&&this.client.ui.setShowcaseIcon(t);break;case"do_not_disturb":n="do_not_disturb",i.containerClass="sysMsg"}return n.length?(t.length&&t!=this.client.username&&this.addMessage(t,this.messages.format(n,i)),!0):!1},hidePencil:function(e){e?this.hidePencilIcon():this.debounceHidePencil()},showPencil:function(){$(".pencil").show(),this.hidePencil()},hidePencilIcon:function(){$(".pencil").hide()}});var Emoticons=function(e){this.imgprefix=e,this.emoticonMap={"smile.gif":["(S)","(s)",":)"],"wink.gif":["(W)","(w)",";)"],"angry.gif":["(A)","(a)",">:("],"surprised.gif":["(O)","(o)",":o",":O"],"frazzled.gif":["(F)","(f)",":s",":S"],"horny.gif":["(H)","(h)"],"embarrassed.gif":["(E)","(e)",":$"],"sad.gif":["(X)","(x)",":("],"unpleasantmood.gif":["(U)","(u)"],"inn.gif":["(M)","(m)"],"kiss.gif":["(K)","(k)",":x"],"gift.gif":["(G)","(g)"],"heart.gif":["(L)","(l)"],"heart_broken.gif":["(B)","(b)"],"rose.gif":["(R)","(r)"],"thumb_up.gif":["(Y)","(y)"],"thumb_down.gif":["(N)","(n)"],"drinks.gif":["(D)","(d)"],"phone.gif":["(C)","(c)"],"tongue.gif":["(T)","(t)",":p",":P"]}};Emoticons.prototype={getUrl:function(e){return this.imgprefix+"v2/private/chat/emoticons/"+e},replaceText:function(e){var t=e;return _.each(this.emoticonMap,function(e,s){var n='<img src="'+this.getUrl(s)+'" alt="'+s+'">';_.each(e,function(e){for(var s=t.indexOf(e);s>-1;)t=t.replace(e,n),s=t.indexOf(e)})},this),t}};var Tabs=function(e){this.current="",this.ui=e,this.specialTabs=["__moreInfo__"]};Tabs.prototype={getId:function(e,t){return e+t.replace(/[^a-z0-9]/gi,"_")},scrollEnd:function(e,t){$(e).each(function(){var e=15,s=$(".message").length*e;t?$(this).animate({scrollTop:s},500):$(this).scrollTop(s)})},hasTab:function(e){if("__moreInfo__"===e)return!0;if(e==this.ui.client.username)return!0;var t=!1;return $(this.getId("#tab_",e)).each(function(){t=!0}),t},addTab:function(e,t,s){var n=this.getId("chatLog_",e);if(this.hasTab(e))s&&$("#"+n).html(t);else{var i=this.getId("tab_",e),a=$("<div></div>").text(e).html(),o=!1;1>this.numTabs()&&(o=!0),$("#tabs").append('<div class="tab" id="'+i+'"><span class="name" alt="'+a+'" title="'+a+'">'+a+'</span><span class="unread"></span> <a href="#" class="closeTab">x</a><div style="clear:both;"></div></div>'),$("#chatLogs").append('<div class="chatLog" id="'+n+'"><div class="logPadder">'+t+"</div></div>"),o?this.setCurrentTab(e):this.setCurrentTab(this.getCurrentTab());var r=this;$("#"+i).click(function(){r.ui.tabs.setCurrentTab(e),$("#"+i).removeClass("changed")}),$("#"+i+" .closeTab").click(function(){r.ui.tabs.removeTab(e)}),this.showTabs()}},numTabs:function(){var e=0;return $(".tab").each(function(){e++}),e},isSpecialTab:function(e){for(var t in this.specialTabs)if(this.specialTabs[t]==e)return!0;return!1},removeTab:function(e){$(this.getId("#tab_",e)).remove(),$(this.getId("#chatLog_",e)).remove(),this.getCurrentTab()==e&&($("#currentName").html(""),$("#extInfo").html("")),this.ui.client.removeTab(e),this.numTabs()||this.setCurrentTab("__moreInfo__")},setCurrentTab:function(e){this.getCurrentTab()!=e&&this.ui.hidePencil(!0),$("#extInfo").html(""),$(".chatLog").hide(),$(this.getId("#chatLog_",e)).show(),$(".tab").removeClass("active"),$(this.getId("#tab_",e)).addClass("active"),"__moreInfo__"==e?$("#currentName").html("&nbsp;"):this.ui.client.profiles.executeFor(e,function(t){if($("#currentName").html(e),t.info!==void 0){var s="<div><ul>";for(var n in t.info)s=s+"<li><strong>"+n+":</strong> "+t.info[n]+"</li>";s+="</ul></div>",$("#extInfo").html(s)}}),this.current=e,this.isSpecialTab(e)?$("#chatMessage").attr("disabled","disabled"):$("#chatMessage").removeAttr("disabled"),this.ui.setShowcaseIcon(e),this.scrollEnd(this.getId("#chatLog_",e),!1)},getCurrentTab:function(){return this.current},toggleTabs:function(){$("#tabs").toggle(),$("#screens,.chatScreen,#chatMain").toggleClass("expanded"),$("#clientContainer, .border-left").toggleClass("expanded2"),$(".tabBar").toggleClass("expanded3"),$("#tabPane").toggleClass("expanded4")},hideTabs:function(){$("#tabs").hide(),$("#screens,.chatScreen,#chatMain").removeClass("expanded"),$("#clientContainer, .border-left").removeClass("expanded2"),$(".tabBar").removeClass("expanded3"),$("#tabPane").removeClass("expanded4")},showTabs:function(){$("#tabs").show(),$("#screens,.chatScreen,#chatMain").addClass("expanded"),$("#clientContainer, .border-left").addClass("expanded2"),$(".tabBar").addClass("expanded3"),$("#tabPane").addClass("expanded4")},removeAllTabs:function(){$(".tab").remove(),$(".chatLog").remove(),this.curent=""}};var Screens=function(e){this.screenId=0,this.ui=e};Screens.prototype={showDialog:function(e,t){$("#sendMessage").focus();var s="screen_"+this.screenId++;$("#screens").append('<div style="display:none;" class="chatScreen" id="'+s+'" name="'+e+'"></div>');var n=this;("collect_message"!=e&&"collect_message_paused"!=e&&"no_session"!=e||this.ui.client.isPaused()||!(this.ui.client.timer()>0))&&this._loadDialog(e,t,s,function(){n.ui.tabs.showTabs(),$("#"+s).show()})},setCurrent:function(e){$(".border-left").show(),$(".chatScreen").hide(),$("#"+e).show()},_loadDialog:function(e,t,s,n){$("#"+s).load("dialog.p",{dialog:e,nickname:t,div_id:s},n)}};var swfName="myFlashContent",isReady=!1,setSWFName=function(e){swfName=e},SWFChatUtil={isSmallChat:function(){return top.frames.headerchat!==void 0},navigateTo:function(e,t){t?top.location=e:top.frames.main.location=e}},swfChatOptions=["flashPrefix","imagePrefix","largeChat","photoUrl","photos","mask","crop","language","gender","tutorial","chatVersion","chatClientVersion","chatLangVersion","summer","fSummer"],SWFChatUI=function(e){this.client=null,this.type="flash",this.initialized=!1,_.extend(this,_.pick(e,swfChatOptions))};_.extend(SWFChatUI.prototype,ChatUI,{init:function(){var e=this;e.initialized||(e.initialized=!0,this._embedSWF())},addUser:function(e,t,s,n){if(isReady){var i={user:e,immersive:s?"true":"false",showcase_granted:t?"true":"false"};void 0!==n&&(i.message=n),thisMovie(swfName).onEvent("user",JSJaCJSON.toString(i))}},addMessage:function(e,t){if(isReady){var s='{"user": "'+e+'", "message": "'+escapeFlash(t)+'"}';thisMovie(swfName).onEvent("message",s)}},onStatusChanged:function(){},logout:function(){},_embedSWF:function(){var e={},t={};e.filePath=this.flashPrefix,e.noPhoto=this.imagePrefix+"lang/"+this.language+"/private/member/profile/view/nopic.jpg",e.lang=this.language,e.debug="false",e.preloaderMovie=e.filePath+"application.swf?"+this.chatClientVersion,e.version=this.chatVersion,e.langversion=this.chatLangVersion,this.largeChat===!0?(e.mainMovie=e.filePath+"largechat.swf",e.moviewidth="100%",e.movieheight="100%",e.chatsize="fullscreen",t.menu="true",t.wmode="opaque",e.crop=encodeURIComponent(JSON.stringify(this.crop)),e.mask=encodeURIComponent(JSON.stringify(this.mask)),e.photos=encodeURIComponent(JSON.stringify(this.photos)),e.tutorial=this.tutorial):(e.mainMovie=e.filePath+"smallchat.swf",e.moviewidth="526",e.movieheight="160",e.chatsize="smallscreen",t.menu="false",t.wmode="transparent"),e.imgprefix=this.imagePrefix,e.photo_url=this.photoUrl,e.username=this.client.username,e.presence=this.client.getPresence(),e.showcase=this.client.hasShowcase()?"true":"",e.gender=this.gender,e.timer=this.client.timer(),e.paused=this.client.isPaused(),e.themeID="01",e.summer=this.summer?1:"",e.fsummer=this.fSummer?1:"",e.low_traffic=this.client.lowTraffic?1:"",t.quality="high",t.scale="default",t.bgcolor="#000000",t.SeamlessTabbing="false",t.allowFullScreen="true",t.AllowScriptAccess="always";var s={};s.id="myFlashContent",swfobject.embedSWF(e.preloaderMovie,"flashContainer",e.moviewidth,e.movieheight,"10.0.0",e.filePath+"expressInstall.swf",e,t,s)},onConnected:function(){if(this.largeChat)for(var e in this.client.tabs())this.client.requestImmersive(e)},onResume:function(){this.onConnected()},onMessage:function(e,t){if(isReady){var s='{"user": "'+e+'", "message": "'+escapeFlash(t)+'"}';thisMovie(swfName).onEvent("message",s)}},addCannedMessage:function(e,t){if(isReady){var s='{"user": "'+e+'", "can_id": "'+t+'"}';thisMovie(swfName).onEvent("canned_message",s)}},onMaskChanged:function(e,t){if(isReady){var s={user:e,revealed:t?"false":"true"},n=JSJaCJSON.toString(s);thisMovie(swfName).onEvent("buddy_mask_reveal",n)}},onEnvironmentChanged:function(e,t){if(isReady){var s='{"user": "'+e+'", "environment_id": "'+t+'"}';thisMovie(swfName).onEvent("environment_changed",s)}},onEnvironmentRequested:function(e,t){isReady&&$.post("ajax.p",{method:"getCredits"},function(s){var n='{"user": "'+e+'", "environment_id": "'+t+'", "credits": '+s.credits+"}";thisMovie(swfName).onEvent("environment_requested",n)},"json")},onEnvironmentRequestDeclined:function(e){if(isReady){var t='{"user": "'+e+'"}';thisMovie(swfName).onEvent("environment_request_declined",t)}},setPausedIcon:function(){var e;e=this.client.isPaused()?'{"pause": "true"}':'{"pause": "false"}',thisMovie(swfName).onEvent("pause",e)},setPausedTitle:function(){},showPause:function(){},hidePause:function(){},addTimeNotice:function(e){if(isReady){var t=JSJaCJSON.toString({title:"",message:getLang("You have %s minutes remaining.").replace(/%s/,e),usepopup:"false"});thisMovie(swfName).onEvent("alert_message",t)}},onIq:function(){},onPresence:function(e,t){if(isReady){var s='{"user": "'+e+'", "presence": "'+t+'"}';thisMovie(swfName).onEvent("presence",s)}},setPresence:function(){},onError:function(){},setShowcase:function(){},typing:function(e){if(isReady){var t='{"user": "'+e+'"}';thisMovie(swfName).onEvent("is_typing",t)}},showDialog:function(e,t){var s=this;isReady&&("collect_message_paused"==e&&(e="collect_message"),$.post("ajax.p",{method:"getCredits"},function(n){var i='{"user": "'+t+'", "credits": "'+n.credits+'"}';thisMovie(swfName).onEvent(e,i),s.client.addUser(t),s.client.profiles.executeFor(t,function(e){s.addUser(t,e.showcase_access)})},"json"))},messageNotify:function(e,t,s){if(isReady){var n;switch(e){case"chat_initiated":setTimeout(function(){thisMovie(swfName).onEvent("chat_initiated","")},1e3);break;case"do_not_disturb":if(isReady)return n='{"user": "'+t+'"}',thisMovie(swfName).onEvent(e,n),!0;break;case"canned_message":if(isReady)return n='{"user": "'+t+'", "can_id": "can_'+s+'"}',thisMovie(swfName).onEvent(e,n),!0;break;case"grant_showcase":if(isReady)return chatClient.addRoster(t),n='{"user": "'+t+'"}',thisMovie(swfName).onEvent(e,n),!0;break;case"revoke_showcase":if(isReady)return n='{"user": "'+t+'"}',thisMovie(swfName).onEvent(e,n),!0;break;case"send_gift":if(isReady)return chatClient.addRoster(t),n='{"user": "'+t+'"}',thisMovie(swfName).onEvent(e,n),!0;break;case"send_gift_done":if(isReady)return n='{"user": "'+t+'"}',thisMovie(swfName).onEvent(e,n),!0;break;case"revoke_showcase_done":if(isReady)return n='{"user": "'+t+'"}',thisMovie(swfName).onEvent(e,n),!0;break;case"grant_showcase_done":if(isReady)return n='{"user": "'+t+'"}',thisMovie(swfName).onEvent(e,n),!0;break;case"profile_upgraded":isReady&&(n="",thisMovie(swfName.onEvent(e,n)));break;default:return!0}}return!1},requestImmersive:function(e){if(isReady){var t=JSJaCJSON.toString({user:e});thisMovie(swfName).onEvent("request_immersive",t)}},enteredWizard:function(e){if(isReady){var t=JSJaCJSON.toString({user:e});thisMovie(swfName).onEvent("buddy_in_wizard",t)}},profileUpdated:function(e){isReady&&(chatClient.profiles.removeData(e),chatClient.profiles.executeFor(e,function(t){var s=JSJaCJSON.toString({user:e,photo:t.photo_url_chat,cropX:""+t.crop_x,cropY:""+t.crop_y,cropWidth:""+t.crop_width,cropHeight:""+t.crop_height});thisMovie(swfName).onEvent("buddy_photo_settings_changed",s);var n=JSJaCJSON.toString({user:e,maskid:""+t.mask_id,maskX:""+t.mask_x,maskY:""+t.mask_y,maskWidth:""+t.mask_width,maskHeight:""+t.mask_height,maskRotation:""+t.mask_rotation});thisMovie(swfName).onEvent("buddy_mask_settings_changed",n),chatClient.ui.onMaskChanged(e,!0)}))},getCurrentTab:function(){return thisMovie(swfName).getSelectedUser()}});